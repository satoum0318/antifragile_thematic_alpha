# スクリーニング仕様マニュアル

`real_data_screening.py` と `JQuamtsScreeningBot.py` のスクリーニング仕様の違いと、実行時の動作をまとめたマニュアルです。

---

## 1. 役割の違い（どちらを実行するか）

| 観点 | **JQuamtsScreeningBot.py** | **real_data_screening.py** |
|------|----------------------------|----------------------------|
| **用途** | 汎用オフライン分析のみ | 汎用オフライン分析 + **テーマ型スクリーニング** |
| **分析モード** | 常に「全キャッシュ銘柄の一括分析」のみ | **プロファイルで切り替え**（後述） |
| **出力先** | `output/reports/` | `output/` 直下 |

どちらも「収集(collect) → 分析(analyze)」の流れは同じで、**分析(analyze)の種類と出力先**が異なります。

---

## 2. 分析(analyze)フェーズの仕様の違い

### JQuamtsScreeningBot.py（analyze の仕様）

- **常に同じ処理**  
  キャッシュが揃っている**全銘柄**を対象に `analyze_single_stock_complete_v3` で一括分析。
- **プロファイル／テーマの概念なし**（`--profile` なし）。
- **出力**  
  - `screening_offline_{ts}.csv`（全銘柄のフラット結果）  
  - その結果から `write_reports` で次のランキングCSVを生成：
    - `top_recommended`（安全・ピオトロスキー・仕手スコアでソート）
    - `top_safety`
    - `top_speculative`
    - `top_piotroski`
    - `top_safe_long_term`（safety_criteria_score でソート）
    - `ranked_with_scores`
    - `report_top10_*.md`, `report_investment_advice_*.md`

→ **「全銘柄を同じ基準でスコア付けし、複数ランキング＋レポートを出す」**仕様です。

---

### real_data_screening.py（analyze の仕様）

- **`--profile` でモードが変わる**（`default` / `aging_dx_alpha`）。

#### プロファイル `aging_dx_alpha` のとき

- **テーマ限定スクリーニング**  
  `config/theme_tags.yaml` と `THEME_CONFIG_PATH` で定義されたテーマ銘柄のうち、  
  **高齢化×DX 関連テーマ**（`AGING_DX_THEME_FILTER`: AGING, NURSING_CARE, HOME_MEDICAL, MEDICAL_DX, SENIOR_LIFE）に該当する銘柄だけを対象に `screen_aging_dx_alpha` を実行。
- **銘柄の絞り込み条件（要約）**  
  - 上記テーマタグに該当  
  - ビジネスモデルが `POLICY_DEPENDENT` でない  
  - ピオトロスキー Fスコア ≥ 7（`AGING_DX_MIN_PIOTROSKI`）  
  - 政策ストレススコア ≥ 2（`AGING_DX_MIN_POLICY_STRESS`）  
  - 売上高 3年CAGR > 0  
  - PSレシオ ≤ 10（`AGING_DX_MAX_PS_RATIO`）  
  - 時価総額 100億〜3000億円  
  - 想定約定金額（価格×出来高）≥ 0.12億円  
  - 財務履歴 4期以上  
- **スコア**  
  Fスコア・成長・政策・モート（ビジネスモデル）の重み付けで `total_score` を算出し、上位 `--top` 件を出力。
- **出力**  
  - `aging_dx_alpha_{ts}.csv`（テーマ＋上記条件を満たした銘柄のみ、`AGING_DX_OUTPUT_COLUMNS` の列構成）

→ **「高齢化×DXテーマに特化した条件で銘柄をスクリーニングし、テーマ用スコアでランキングする」**仕様です。

#### プロファイル `default` のとき

- **JQuamtsScreeningBot とほぼ同じ**  
  全キャッシュ銘柄を `analyze_single_stock_complete_v3` で一括分析し、同じ `write_reports` / `write_markdown_report` / `write_investment_advice_report` で  
  `screening_offline_*.csv` と各種 top_* / ranked_with_scores / レポートを出力。
- 違いは **出力先が `output/` 直下**であることと、**単銘柄時に `write_single_stock_report` で詳細レポートも出す**こと程度。

---

## 3. その他の実装上の違い

| 項目 | JQuamtsScreeningBot.py | real_data_screening.py |
|------|------------------------|-------------------------|
| **テーマ・YAML** | なし（theme_tags / yaml 未使用） | `config/theme_tags.yaml`、`load_theme_tags`、AGING_DX 定数を使用 |
| **CLI 引数** | `--profile` なし | `--profile default \| aging_dx_alpha` |
| **単銘柄分析** | CSV のみ | CSV + `write_single_stock_report` で詳細レポート（`single_{code}_{ts}_report.md`） |
| **安全・長期向け** | `write_reports` 内の `top_safe_long_term` のみ（全銘柄結果からソート） | 上記に加え、**専用関数 `screen_safe_long_term_investment`** あり（PSR<1、営業CF>0、自己資本比率≥50%、仕手株除外などでフィルタし、別CSV出力可能） |
| **_flatten_result** | `safety_criteria` を `total_score` 等に展開 | 同様＋`ps_under_1`, `cash_rich`, `equity_ratio`, `max_drawdown`, `sales_cagr` など安全基準の項目をより多くフラット化 |
| **レポート例外** | レポート生成で例外時はログ＋メッセージ表示 | 投資助言レポートは try/except で握りつぶし（表示のみ） |
| **収集時** | 会社名チェック `check_company_name_validity` で銘柄リストをフィルタ | 同様（同じロジック） |

---

## 4. どちらを実行するとどうなるか（まとめ）

- **JQuamtsScreeningBot.py を実行する場合**  
  - 常に「キャッシュ済み全銘柄のオフライン一括分析」のみ。  
  - 銘柄は「キャッシュが揃っている全銘柄」で、テーマやプロファイルによる絞り込みはなし。  
  - 出力は `output/reports/` の  
    `screening_offline_*.csv` ＋ 各種 top_* / ranked_with_scores / レポート。

- **real_data_screening.py を実行する場合**  
  - **`--profile default`（省略時）**  
    → 上と同様の「全銘柄一括分析」だが、出力は `output/` 直下。単銘柄時は詳細レポートあり。  
  - **`--profile aging_dx_alpha`**  
    → 銘柄は「テーマタグで高齢化×DXに該当し、かつ Fスコア・時価・流動性・政策スコアなどの条件を満たす銘柄」だけに絞られ、  
     それらをテーマ用スコアでランキングした `aging_dx_alpha_*.csv` が出力される。

---

## 5. 実行例

### JQuamtsScreeningBot.py

```bash
# 対話メニュー
python JQuamtsScreeningBot.py

# 収集（本日分）
python JQuamtsScreeningBot.py --phase collect --budget 380

# 全銘柄オフライン分析（トップ10など）
python JQuamtsScreeningBot.py --phase analyze --top 10

# 単銘柄分析
python JQuamtsScreeningBot.py --phase single --code 8035
```

### real_data_screening.py

```bash
# 対話メニュー
python real_data_screening.py

# 収集
python real_data_screening.py --phase collect --budget 380

# 全銘柄オフライン分析（default）
python real_data_screening.py --phase analyze --top 10

# 高齢化×DXテーマ専用スクリーニング
python real_data_screening.py --phase analyze --profile aging_dx_alpha --top 20

# 単銘柄分析（詳細レポート付き）
python real_data_screening.py --phase single --code 8035
```

---

## 6. 使い分けの目安

| 目的 | 推奨 |
|------|------|
| 全銘柄を同じ基準でランキングしたい | JQuamtsScreeningBot または real_data_screening（`--profile default`） |
| 高齢化×DXテーマに特化して銘柄をスクリーニングしたい | real_data_screening（`--profile aging_dx_alpha`） |
| 出力を `output/reports/` にまとめたい | JQuamtsScreeningBot |
| 単銘柄の詳細レポート（Markdown）が欲しい | real_data_screening（`--phase single`） |

---

*最終更新: 2025年2月*
